### 4장에서 다루는 내용
- 파드의 안정적인 유지
- 동일한 파드의 여러 인스턴스 실행
- 노드 장애 시 자동으로 파드 재스케줄링
- 파드의 수평 스케줄링
- 각 클러스터 노드에서 시스템 수준의 파드 실행
- 배치 잡 실행
- 잡을 주기적 또는 한번만 실행하도록 스케줄링

지금까지 살펴본 바와 같이 쿠버네티스에서 파드는 배포 가능한 기본 단위이다. 파드를 수동으로 생성, 감독, 관리하는 방법을 배웠지만 실환경에서는 배포한 애플리케이션이 자동으로 실행되고
수동적인 개입 없이도 안정적인 상태로 유지되길 원한다. 직접 파드를 생성하는 일은 거의 없고 `ReplicationController` 또는 `Deployment`와 같은 유형의 리소스를 생성해 실제 파드를 생성하고 관리한다.

## 파드를 안정적으로 유지하기
- 파드가 노드에 스케줄링되는 즉시, 해당 노드의 `kubelet`은 파드의 컨테이너를 실행하고 파드가 존재하는 한 컨테이너가 계속 실행되도록 한다.
- 애플리케이션에서 `크래쉬(crash)`가 발생하면 `kubelet`이 컨테이너를 다시 시작한다.
- 애플리케이션에서 특별한 작업을 하지 않아도 쿠버네티스에서 애플리케이션을 실행하는 것만으로도 자동으로 치유할 수 있는 능력이 주어진다.

### 라이브니스 프로브 소개
- 쿠버네티스는 `라이브니스 프로브(liveness probe)`를 통해 컨테이너가 살아있는지 확인할 수 있다.
- 쿠버네티스는 주기적으로 프로브를 실행하고 프로브가 실패한 경우 컨테이너를 다시 시작한다.

### 쿠버네티스는 세 가지 메커니즘을 사용해 컨테이너에 프로브를 실행한다.

- `HTTP GET 프로브`는 지정한 IP주소, 포트, 경로에 HTTP GET 요청을 수행한다.프로브가 응답을 수신하고 오류가 나타내지 않을경우 성공으로 간주하고 오류코드를 반환하거나
응답이 없을시 실패한것으로 간주해 컨테이너를 다시 시작한다.
- `TCP 소켓 프로브`는 컨테이너의 지정된 포트에 TCP 연결을 시도한다. 연결에 성공하면 프로브가 성공한 것이고, 그렇지 않으면 컨테이너가 다시 시작된다.
- `Exec 프로브`는 컨테이너 내의 임의의 명령을 실행하고 명령의 종료 상태 코드를 확인한다. 상태 코드가 0이면 프로브가 성공한 것이고 다른 코드는 실패로 간주된다.

### HTTP 기반 라이브니스 프로브 생성
- 적절한 라이브니스 프로브 데모를 위해 애플리케이션을 약간 수정해 다섯번째 이후의 요청부터는 `500 Internal Server Error HTTP` 상태 코드를 반환하도록 한다.

![image](https://user-images.githubusercontent.com/81672260/148008595-f573c1f9-95da-4154-81d0-e94a064b63a3.png)

luksa/kubia-unhealthy : 약간 문제가 있는 애플리케이션을 포함한 이미지 (일부로 쿠버네티스가 프로브를 실패한것으로 간주하고 컨테이너를 재시작 하도록 하기위해)

- 이 파드 디스크립터는 쿠버네티스가 주기적으로 "/" 경로와 `8080`포트에 `HTTP GET`을 요청해서 컨테이너가 정상 동작하는지 확인하도록 `HttpGet Liveness Probe`를 정의한다.
- 다섯 번의 요청 후에 애플리케이션은 HTTP 상태 코드 500을 반환하기 시작하고 쿠버네티스가 프로브를 실패한 것으로 간주해 컨테이너를 다시 시작한다.

![image](https://user-images.githubusercontent.com/81672260/148010132-2c60690b-9163-4916-8c02-e18ab48971e6.png)

자동으로 재시작 후

![image](https://user-images.githubusercontent.com/81672260/148010372-25fc2aac-187c-4989-9efe-5603a5870b15.png)

## 동작 중인 라이브니스 프로브 확인

```
kubectl create -f kubia-liveness-probe.yaml
kubect get po kubia-liveness
```
![image](https://user-images.githubusercontent.com/81672260/148009025-88dad15a-84a7-466e-8612-58a5cebde693.png)

- RESTARTS 열에는 파드의 컨테이너가 한 번 다시 시작했음을 보여준다 (1분 30초 더 기다리면 다시 시작하고 이 주기는 무한 반복)


컨테이너가 다시 시작된 후의 파드 디스크립션

 ```
 kubectl describe po kubia-liveness
 ```
 
 ![image](https://user-images.githubusercontent.com/81672260/148009946-f397e381-b82e-4891-b4d9-2b0cda2296ad.png)

종료 코드는 137이며 외부 신호에 의해 종료됐음을 나타낸다.
 
 ### 라이브니스 프로브의 추가 속성 설정
 ![image](https://user-images.githubusercontent.com/81672260/148010317-547a7c31-b844-419a-b381-421160a0fa76.png)

- 명시적으로 지정한 라이브니스 프로브 옵션 외에도 지연(delay), 제한시간(timeout), 기간(period)등과 같은 추가 속성을 볼 수도 있다.
- delay=0s 부분은 컨테이너가 시작된 후 바로 프로브가 시작된다는 것을 나타낸다.
- 제한 시간이 1초로 설정되어 있으므로(timeout=1s) 컨테이너가 1초 안에 응답해야 한다. 그렇지 않으면 실패한 것으로 카운트된다.
 
![image](https://user-images.githubusercontent.com/81672260/148010786-70a05c4a-a329-4cc6-8a21-514a508cd31d.png)

## 레플리케이션컨트롤러(Replication Controller) 소개

- 레플리케이션컨트롤러(rc)는 쿠버네티스 리소스로서 파드가 항상 실행되도록 보장한다.
- 노드가 사라지거나 노드에서 파드가 제거된 경우, rc는 사라진 파드를 감지해 교체 파드를 생성한다.

![image](https://user-images.githubusercontent.com/81672260/148017611-5cfa9408-0dfb-465c-a7f0-97b5163de7c8.png)
노드 1의 파드 A는 종료된 이후, rc가 관리하지 않기 때문에 다시 생성되지 않는다.
rc는 파드 B가 사라진것을 인지하고 새로운 파드 인스턴스를 만든다.
