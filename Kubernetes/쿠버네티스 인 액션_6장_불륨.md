## 불륨 소개
- 쿠버네티스 불륨(Volume)은 파드의 구성 요소로 컨테이너와 동일하게 파드 스펙에서 정의된다.
- 불륨은 독립적인 쿠버네티스 오브젝트가 아니므로 자체적으로 생성, 삭제될 수 없다.
- 불륨은 파드의 모든 컨테이너에서 사용 가능하지만 접근하려는 컨테이너에서 각각 마운트 돼야한다.

## 사용 가능한 불륨 유형 소개
- emptyDir : 일시적인 데이터를 저장하는 데 사용되는 간단한 빈 디렉터리이다.
- hostPath : 워커 노드의 파일시스템을 파드의 디렉터리로 마운트하는 데 사용한다.
- gitRepo : 깃 리포지터리의 콘텐츠를 체크아웃해 초기화한 불륨이다.
- nfs : NFS 공유를 파드에 마운트한다.
- gcePersistentDisk, awsElasticBlockStore, AzureDisk : 클라우드 제공자의 전용 스토리지를 마운트하는 데 사용한다.
- cinder, cephfs, iscsi, flocker ... : 다른 유형의 네트워크 스토리지를 마운트하는 데 사용한다.
- configMap, secret, downwardAPI : 쿠버네티스 리소스나 클러스터 정보를 파드에 노출하는 데 사용되는 특별한 유형의 볼륨.
- persistentVolumeClaim : 사전에 혹은 동적으로 프로비저닝된 퍼시스턴트 스토리지를 사용하는 방법이다.

## 불륨을 사용한 컨테이너 간 데이터 공유

### empthDir 볼륨 사용
- 불륨이 빈 디렉토리로 시작된다.
- 파드에 실행중인 애플리케이션은 어떤 파일이든 볼륨에 쓸 수 있다.

### 파드에 emptyDir 볼륨 사용
- 웹 서버 컨테이너와 콘텐츠 에이전트, HTML을 위한 단일 볼륨으로 파드를 구성한다.
- Nginx를 웹 서버로 사용하고 유닉스 fortune 명령으로 HTML 콘텐츠를 생성한다.

### Fortune 컨테이너 이미지 빌드하기
![image](https://user-images.githubusercontent.com/81672260/162367021-daa15495-3b74-41ad-9d50-cbe569ff16ed.png)
-> fortuneloop.sh

![image](https://user-images.githubusercontent.com/81672260/162367055-9fd4a8cf-5005-4fee-9aec-5101e615548a.png)
-> Dockerfile

```
sudo chmod 666 /var/run/docker.sock 
docker build -t oilehot0910/fortune .
docker push oilehot0910/fortune
```

## 파드 생성하기

```
kubectl create -f fortune-pod.yaml
```

- 동일한 불륨을 공유하는 컨테이너 두 개가 있는 파드
![image](https://user-images.githubusercontent.com/81672260/162382110-60fd04f8-2a14-4ed9-841d-e3fe5483807f.png)

## 실행 중인 파드 보기
- Fortune 메시지를 보려면 파드의 접근을 활성화해야 한다. 이 작업은 로컬 머신의 포트를 파드로 포워딩하면 된다.
```
kubectl port-forward fortune 8080:80
curl http://localhost:8080
```
![image](https://user-images.githubusercontent.com/81672260/162395779-73dd4c81-d4a1-4d4b-bf9f-2572acf24c7d.png)

## 깃 리포지터리를 볼륨으로 사용하기
- gitRepo 볼륨은 기본적으로 emptyDir 볼륨이며 파드가 시작되면 깃 리포지터리를 복제하고 특정 리비전을 체크아웃해 데이터로 채운다.

1. 사용자 혹은 레플리케이션 컨트롤러가 gitRepo 볼륨을 가진 파드를 생성한다.
2. 쿠버네티스는 빈 디렉터리를 생성하고 특정 깃 리포지터리를 복제한다.
3. 파드의 컨테이너가 마운트 경로에 볼륨이 마운트된 상태에서 시작한다.

## 복제된 깃 리포지터리 파일을 서비스하는 웹 서버 실행하기

![image](https://user-images.githubusercontent.com/81672260/162901925-96b2a778-7c06-4d94-9103-fd4996ba3f2a.png)


## 워커 노드 파일시스템의 파일 접근
- 대부분의 파드는 호스트 노드를 인식하지 못하므로 노드의 파일시스템에 있는 어떤 파일에 접근하면 안 된다.
- 쿠버네티스는 hostPath 볼륨으로 가능케 한다.

## hostPath 볼륨 소개
- hostPath 볼륨은 노드 파일시스템의 특정 파일이나 디렉터리를 가리킨다.

## GCE 퍼시스던트 디스크 생성하기
- 쿠버네티스 클러스터가 있는 동일한 zone에 생성한다.


```
gcloud compute disks create --size=1GiB --zone=asia-east1-b mongodb
```
![image](https://user-images.githubusercontent.com/81672260/163523601-ea6f0eb8-ec2c-4b79-bad8-a7362b2d048d.png)


## GCE 퍼시스턴트 디스크 볼륨을 사용하는 파드 생성하기

![image](https://user-images.githubusercontent.com/81672260/163523956-e3254098-1c14-4882-8550-dc009d740632.png)

- 생성한 GCE 퍼시스턴트 디스크를 기반으로 한 단일 볼륨과 단일 컨테이너로 이뤄진다.
- 볼륨을 컨테이너 내부의 MongoDB가 데이터를 저장하는 /data/db 에 마운트한다.

## MongoDB 데이터베이스에 Document를 추가해 퍼시스턴트 스토리지에 데이터 쓰기
```
kubectl create -f mongodb-pod-gcepd.yaml
```

