## 서비스 소개
- 웹 서버가 하나든 수백 개든 상관없이 외부 클라이언트는 프론트엔드 파드에 연결할 수 있어야 한다.
- 프론트엔드 파드는 백엔드 데이터베이스에 연결해야 한다.

![image](https://user-images.githubusercontent.com/81672260/161502503-ec70777f-d86a-4583-ac8a-09e79b4ecd2d.png)

## 서비스 생성

- kubectl expose로 서비스 생성

```
kubectl create –f kubia-svc.yaml
kubectl get po
kubectl exec kubia-5dz2n – curl –s http://10.80.15.170
```

![image](https://user-images.githubusercontent.com/81672260/161507928-abafd268-d53b-4a0f-b36c-715a0a82a668.png)  
![image](https://user-images.githubusercontent.com/81672260/161507942-4b2dbe40-89a7-4ff9-9106-fca0ef8b01e1.png)  
![image](https://user-images.githubusercontent.com/81672260/161507960-a2e1f837-8fd5-49b9-92d9-759f548d1369.png)  

1. kubectl exec
2. curl은 node.js를 실행하고 있는 컨테이너 내에서 실행된다.
3. curl은 HTTP GET 요청을 보낸다.
4. 서비스는 HTTP연결을 임의의 파드로 전달한다.
5. HTTP 응답은 다시 curl로 전송된다.

## 서비스 세션 어피니티 구성
- 동일한 명령을 몇 번 더 실행하면 동일한 클라이언트에서 요청하더라도 서비스 프록시가 각 연결을 임의의 파드를 선택해 전달하기 때문에 요청할 때마다 다른 파드가 선택된다.
- 특정 클라이언트의 모든 요청을 매번 같은 파드로 리디렉션 하려면 세션어피니티(sessionAffinity)를 None대신 ClientIP로 설정한다.

![image](https://user-images.githubusercontent.com/81672260/161509411-a52f44cb-5c5e-4061-9d39-f1344efe4735.png)


## 서비스 검색
- 서비스를 만들면 파드에 액세스할 수 있는 안정적인 IP 주소와 포트가 생긴다.
- 항상 서비스의 IP 주소로 액세스할 수 있어야 한다.

1. 환경변수를 통한 서비스 검색
- 서비스에 대한 환경변수를 보려면 먼저 모든 파드를 삭제하고 rc에서 새로 파드를 만들어야한다.
```
kubectl delete po –all
```
2. DNS를 통한 서비스 검색
- 각 서비스는 내부 DNS 서버에서 DNS 항목을 가져오고 서비스 이름을 알고 있는 클라이언트 파드는 환경변수 대신 FQDN(정규화된 도메인 이름)으로 액세스할 수 있다.

3. FQDN을 통한 서비스 연결
- 프론트엔드-백엔드 예제를 다시 보면 프론트엔드 파드는 다음 FQDN로 백엔드 데이터베이스 서비스에 연결할 수 있다.

4. 파드 컨테이너 내에서 셸 실행
- kubectl exec 명령어를 사용해 파드의 컨테이너 내에서 bash를 실행할 수 있다.

## 서비스 엔드포인트 소개
- 서비스는 직접 연결되지 않는다. 대신 엔드포인트가 그 사이에 있다.

```
kubectl describe svc kubia
```
![image](https://user-images.githubusercontent.com/81672260/162102588-e0283207-49ed-47e9-842c-538b2187a34d.png)

```
kubectl get endpoints kubia
```
![image](https://user-images.githubusercontent.com/81672260/162102644-d20634c8-9033-4ec5-a767-d08c48a305ff.png)

## 외부 클라이언트에 서비스 노출  

### 1. 노드포트로 서비스 유형 설정 
- 노드포드(NodePort)서비스의 경우 각 클러스터 노드는 노드 자체에서 포트를 열고 해당 포트로 수신된 트래픽을 서비스로 전달한다.
- 이 서비스는 내부 클러스터 IP와 포트로 액세스할 수 있을 뿐만 아니라 모든 노드의 전용 포트로도 액세스할 수 있다.

### 2. 서비스 유형을 노드포트 유형의 확장인 로드밸런서로 설정
- 쿠버네티스가 실행 중인 클라우드 인프라에서 프로비저닝된 전용 로드밸런서로 서비스에 액세스할 수 있다.

### 3. 단일 IP 주소로 여러 서비스를 노출하는 인그레스 리소스 만들기
- HTTP 레벨(네트워크7계층)에서 작동하므로 4계층 서비스 보다 더 많은 기능을 제공할 수 있다.



